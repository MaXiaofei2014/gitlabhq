%li.timeline-entry{ id: dom_id(note), class: dom_class(note), data: { discussion: note.discussion_id } }
  .timeline-entry-inner
    .timeline-icon
      = image_tag avatar_icon(note.author_email), class: "avatar s40"
    .timeline-content
      .note-header
        .note-actions
          = link_to "##{dom_id(note)}", name: dom_id(note) do
            %i.fa.fa-link
            链接
          &nbsp;
          - if can?(current_user, :admin_note, note) && note.editable?
            = link_to "#", title: "编辑评论", class: "js-note-edit" do
              %i.fa.fa-pencil-square-o
              编辑
            &nbsp;
            = link_to project_note_path(@project, note), title: "删除评论", method: :delete, data: { confirm: '确定要删除评论么？' }, remote: true, class: "danger js-note-delete" do
              %i.fa.fa-trash-o.cred
              删除
        = link_to_member(@project, note.author, avatar: false)
        %span.author-username
          = '@' + note.author.username
        %span.note-last-update
          = note_timestamp(note)

        - if note.upvote?
          %span.vote.upvote.label.label-success
            %i.fa.fa-thumbs-up
            \+1
        - if note.downvote?
          %span.vote.downvote.label.label-danger
            %i.fa.fa-thumbs-down
            \-1


      .note-body
        .note-text
          = preserve do
            = markdown(note.note, {no_header_anchors: true})

        .note-edit-form
          = form_for note, url: project_note_path(@project, note), method: :put, remote: true, authenticity_token: true do |f|
            = render layout: 'projects/md_preview' do
              = f.text_area :note, class: 'note_text js-note-text markdown-area js-gfm-input turn-on'

            .form-actions.clearfix
              = f.submit '保存修改', class: "btn btn-primary btn-save js-comment-button"

              .note-form-option
                %a.choose-btn.btn.js-choose-note-attachment-button
                  %i.fa.fa-paperclip
                  %span 选择文件...
                &nbsp;
                %span.file_name.js-attachment-filename 文件名...
                = f.file_field :attachment, class: "js-note-attachment-input hidden"

              = link_to  '取消', "#", class: "btn btn-cancel note-edit-cancel"


      - if note.attachment.url
        .note-attachment
          - if note.attachment.image?
            = link_to note.attachment.secure_url, target: '_blank' do
              = image_tag note.attachment.secure_url, class: 'note-image-attach'
          .attachment
            = link_to note.attachment.secure_url, target: "_blank" do
              %i.fa.fa-paperclip
              = note.attachment_identifier
              = link_to delete_attachment_project_note_path(@project, note),
                title: "删除此附件", method: :delete, remote: true, data: { confirm: '确定要删除此附件么？' }, class: "danger js-note-attachment-delete" do
                %i.fa.fa-trash-o.cred
      .clear
